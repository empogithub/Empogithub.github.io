<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polish√§ndelser</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
/* ====== BL√ÖTT TEMA ====== */
:root {
    --blue-main: #0b4edb;
    --blue-light: #e8f0ff;
    --blue-dark: #083a9b;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: #ffffff;
    color: #0f172a;
}

/* ====== HEADER ====== */
header {
    padding: 14px;
    font-size: 1.2em;
    font-weight: 600;
    background: var(--blue-main);
    color: white;
}

/* ====== MAP ====== */
#map {
    height: 45vh;
    width: 100%;
}

/* ====== TABLE ====== */
.table-wrapper {
    padding: 10px;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
}

th {
    background: var(--blue-light);
    color: var(--blue-dark);
    padding: 10px;
    text-align: left;
    border-bottom: 2px solid #c7d7ff;
}

td {
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
}

tr:hover {
    background: #f0f6ff;
    cursor: pointer;
}

.place {
    color: var(--blue-main);
    font-weight: 500;
    text-decoration: underline;
}

/* ====== TURNSTILE OVERLAY ====== */
#verifyOverlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0b4edb, #0a3fa8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.verify-box {
    background: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}

.verify-box h2 {
    margin-top: 0;
    color: var(--blue-main);
}

/* Mobil */
@media (max-width: 600px) {
    #map {
        height: 40vh;
    }
}
</style>
</head>

<body>

<!-- üîê TURNSTILE OVERLAY -->
<div id="verifyOverlay">
    <div class="verify-box">
        <h2>Verifierar bes√∂kare</h2>
        <p>V√§nligen v√§nta‚Ä¶</p>

        <div class="cf-turnstile"
             data-sitekey="0x4AAAAAACKmybsgBUX-U7HE"
             data-callback="onVerified">
        </div>
    </div>
</div>

<header>üöì Polish√§ndelser ‚Äì Sverige</header>

<div id="map"></div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Typ</th>
                <th>Plats</th>
                <th>Tid</th>
                <th>Sammanfattning</th>
            </tr>
        </thead>
        <tbody id="eventTable"></tbody>
    </table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;

function onVerified() {
    document.getElementById("verifyOverlay").style.display = "none";
    initMap();
    loadEvents();
}

function initMap() {
    map = L.map("map").setView([59.3293, 18.0686], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "¬© OpenStreetMap"
    }).addTo(map);
}

async function loadEvents() {
    const table = document.getElementById("eventTable");

    const res = await fetch("https://polisen.se/api/events");
    const data = await res.json();

    data.forEach(event => {
        if (!event.location?.gps) return;

        const [lat, lon] = event.location.gps.split(",");

        const marker = L.marker([lat, lon]).addTo(map)
            .bindPopup(`
                <strong>${event.type}</strong><br>
                üìç ${event.location.name}<br>
                üïí ${event.datetime}<br><br>
                ${event.summary}
            `);

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><strong>${event.type}</strong></td>
            <td class="place">${event.location.name}</td>
            <td>${event.datetime}</td>
            <td>${event.summary}</td>
        `;

        tr.onclick = () => {
            map.setView([lat, lon], 14, { animate: true });
            marker.openPopup();
        };

        table.appendChild(tr);
    });
}
</script>

</body>
</html>