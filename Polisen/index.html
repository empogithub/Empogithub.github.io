<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>PolishÃ¤ndelser â€“ Karta</title>

<!-- Leaflet (karta) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: white;
        color: #000;
    }

    header {
        padding: 15px;
        text-align: center;
        font-size: 1.3em;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
    }

    #map {
        height: 80vh;
        width: 100%;
    }

    .verify-box {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    @media (max-width: 600px) {
        header {
            font-size: 1.1em;
        }
    }
</style>
</head>

<body>

<header>ğŸš“ PolishÃ¤ndelser â€“ Live karta</header>

<!-- Cloudflare verifiering -->
<div class="verify-box">
    <div class="cf-turnstile"
         data-sitekey="0x4AAAAAACKmybsgBUX-U7HE"
         data-callback="onVerified">
    </div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let verified = false;

function onVerified() {
    verified = true;
    initMap();
    loadEvents();
}

function initMap() {
    map = L.map('map').setView([59.3293, 18.0686], 6); // Sverige

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);
}

async function loadEvents() {
    if (!verified) return;

    try {
        const res = await fetch("https://polisen.se/api/events");
        const data = await res.json();

        data.forEach(event => {
            if (!event.location || !event.location.gps) return;

            const [lat, lon] = event.location.gps.split(",");

            L.marker([lat, lon]).addTo(map)
                .bindPopup(`
                    <strong>${event.type}</strong><br>
                    ğŸ“ ${event.location.name}<br>
                    ğŸ•’ ${event.datetime}<br><br>
                    ${event.summary}
                `);
        });

    } catch (e) {
        alert("Kunde inte ladda polishÃ¤ndelser");
        console.error(e);
    }
}
</script>

</body>
</html>