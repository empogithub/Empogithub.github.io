<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polish√§ndelser</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
:root {
    --blue-main: #0b4edb;
    --blue-soft: #eef4ff;
    --blue-border: #c7d7ff;
    --blue-text: #0f172a;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: white;
    color: var(--blue-text);
}

header {
    background: var(--blue-main);
    color: white;
    padding: 16px;
    font-size: 1.3em;
    font-weight: 700;
}

/* MAP */
#map {
    display: none;
    height: 45vh;
    width: 100%;
    border-bottom: 3px solid var(--blue-border);
}

/* TABLE */
.table-wrapper {
    padding: 14px;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
}

th {
    background: var(--blue-soft);
    color: var(--blue-main);
    padding: 12px;
    border-bottom: 2px solid var(--blue-border);
    text-align: left;
}

td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
}

tr:hover {
    background: var(--blue-soft);
    cursor: pointer;
}

.type {
    font-weight: 700;
    color: var(--blue-main);
}

.place {
    font-weight: 600;
    text-decoration: underline;
    color: var(--blue-main);
}

/* Mobile */
@media (max-width: 600px) {
    #map {
        height: 40vh;
    }
}
</style>
</head>

<body>

<header>üöì Polish√§ndelser ‚Äì Sverige</header>

<div id="map"></div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Typ</th>
                <th>Plats</th>
                <th>Tid</th>
                <th>Sammanfattning</th>
            </tr>
        </thead>
        <tbody id="eventTable"></tbody>
    </table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let mapReady = false;
let activeMarker;

async function loadEvents() {
    const table = document.getElementById("eventTable");
    const res = await fetch("https://polisen.se/api/events");
    const data = await res.json();

    data.forEach(event => {
        if (!event.location?.gps) return;

        const [lat, lon] = event.location.gps.split(",");

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="type">${event.type}</td>
            <td class="place">${event.location.name}</td>
            <td>${event.datetime}</td>
            <td>${event.summary}</td>
        `;

        tr.onclick = () => showMap(lat, lon, event);
        table.appendChild(tr);
    });
}

function showMap(lat, lon, event) {
    const mapDiv = document.getElementById("map");
    mapDiv.style.display = "block";

    if (!mapReady) {
        map = L.map("map").setView([lat, lon], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: "¬© OpenStreetMap"
        }).addTo(map);
        mapReady = true;
    } else {
        map.setView([lat, lon], 14, { animate: true });
        if (activeMarker) map.removeLayer(activeMarker);
    }

    activeMarker = L.marker([lat, lon])
        .addTo(map)
        .bindPopup(`
            <strong>${event.type}</strong><br>
            üìç ${event.location.name}<br>
            üïí ${event.datetime}<br>
            ${event.summary}
        `)
        .openPopup();

    map.invalidateSize();
}

loadEvents();
</script>

</body>
</html>